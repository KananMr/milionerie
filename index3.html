<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dev Millionaire</title>
    <style>
        :root {
            --primary: #3a0ca3;
            --secondary: #4361ee;
            --accent: #f72585;
            --background: #1a1a2e;
            --card-bg: #16213e;
            --text: #e6e6e6;
            --correct: #4cc9f0;
            --wrong: #f72585;
            --disabled: #4a4e69;
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: var(--background);
            color: var(--text);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        /* Light Mode Styles */
        body.light-mode {
            --primary: #5e548e; /* Lighter purple */
            --secondary: #9f86c0; /* Even lighter purple */
            --accent: #f72585; /* Keep accent for pop */
            --background: #f0f0f0; /* Light gray/white */
            --card-bg: #ffffff; /* White cards */
            --text: #333333; /* Dark text */
            --correct: #4cc9f0; /* Keep correct color */
            --wrong: #f72585; /* Keep wrong color */
            --disabled: #adb5bd; /* Lighter disabled */
        }

        body.light-mode header {
            background-color: var(--primary);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* Lighter shadow */
        }
        body.light-mode h1 {
            color: white; /* Keep white for contrast with primary */
        }
         body.light-mode .question-container, body.light-mode .progress {
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        body.light-mode .option {
            background-color: var(--secondary);
            color: white; /* Text on secondary buttons */
        }
         body.light-mode .option:hover:not(:disabled) {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        body.light-mode .option.correct {
            background-color: var(--correct);
            color: black; 
        }
        body.light-mode .option.wrong {
            background-color: var(--wrong);
            color: white;
        }
        body.light-mode .option-prefix {
             background-color: rgba(255, 255, 255, 0.2); /* Lighter prefix bg */
        }
        body.light-mode .lifeline {
            border: 2px solid var(--accent);
            color: var(--accent);
            background-color: var(--card-bg);
        }
        body.light-mode .lifeline:hover:not(:disabled) {
            background-color: var(--accent);
            color: white;
        }
        body.light-mode .lifeline:disabled {
            border-color: var(--disabled);
            color: var(--disabled);
        }
        body.light-mode .prize-level.current {
            background-color: var(--primary);
            color: white;
        }
        body.light-mode .prize-level.passed {
            background-color: rgba(76, 201, 240, 0.1); /* Lighter passed bg */
        }
        body.light-mode .timer-value {
            color: var(--accent);
        }
        body.light-mode .modal-content {
            background-color: var(--card-bg);
        }
        body.light-mode .modal-title {
            color: var(--accent);
        }
        body.light-mode .modal-button {
             background-color: var(--accent);
             color: white;
        }
        body.light-mode .modal-button:hover {
            background-color: #d3166d;
        }
        body.light-mode .audience-bar {
            background-color: var(--secondary);
        }
        body.light-mode .phone-friend {
            background-color: rgba(0,0,0,0.05); /* Very light bg for friend text */
        }
        body.light-mode .start-button, body.light-mode .restart-button {
            background-color: var(--accent);
            color: white;
        }
        body.light-mode .start-button:hover, body.light-mode .restart-button:hover {
            background-color: #d3166d;
        }
        body.light-mode .category {
             background-color: var(--card-bg);
             border: 2px solid var(--secondary);
             color: var(--text);
        }
        body.light-mode .category:hover, body.light-mode .category.selected {
            background-color: var(--secondary);
            color: white;
        }
        body.light-mode .dark-mode-toggle {
            background-color: var(--primary); /* Use light mode primary */
            color: white; /* Text on toggle */
        }


        header {
            background-color: var(--primary);
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        h1 {
            margin: 0;
            font-size: 2rem;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .game-area {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .question-container {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .question {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            line-height: 1.4;
        }

        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .options {
                grid-template-columns: 1fr;
            }
        }

        .option {
            background-color: var(--secondary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 1rem;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            display: flex;
            align-items: center;
        }

        .option:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .option:disabled {
            background-color: var(--disabled);
            cursor: not-allowed;
        }

        .option.correct {
            background-color: var(--correct);
            color: black;
        }

        .option.wrong {
            background-color: var(--wrong);
        }

        .option-prefix {
            font-weight: bold;
            margin-right: 0.5rem;
            background-color: rgba(0, 0, 0, 0.2);
            padding: 0.3rem 0.6rem;
            border-radius: 50%;
        }

        .lifelines {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .lifeline {
            background-color: var(--card-bg);
            border: 2px solid var(--accent);
            color: var(--accent);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .lifeline:hover:not(:disabled) {
            background-color: var(--accent);
            color: white;
        }

        .lifeline:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: var(--disabled);
            color: var(--disabled);
        }

        .progress {
            display: flex;
            flex-direction: column-reverse;
            gap: 0.5rem;
            background-color: var(--card-bg);
            padding: 1rem;
            border-radius: 10px;
        }

        .prize-level {
            padding: 0.5rem 1rem;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
        }

        .prize-level.current {
            background-color: var(--primary);
            color: white;
        }

        .prize-level.passed {
            background-color: rgba(76, 201, 240, 0.2);
        }

        .prize-amount {
            font-weight: bold;
        }

        .timer {
            text-align: center;
            font-size: 1.5rem;
            margin: 1rem 0;
        }

        .timer-value {
            font-weight: bold;
            color: var(--accent);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content { /* This is the main modal box */
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .modal-title {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: var(--accent);
        }

        .modal-message {
            font-size: 1.2rem;
            margin-bottom: 1rem; /* Adjusted margin */
        }
        
        #modal-dynamic-area { /* Dedicated area for dynamic content */
            margin-bottom: 2rem; /* Space before the button */
        }

        .modal-button {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-button:hover {
            background-color: #d3166d;
        }

        .audience-chart {
            width: 100%;
            height: 200px;
            margin: 1rem 0;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
        }

        .audience-bar {
            width: 20%;
            background-color: var(--secondary);
            transition: height 0.5s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            color: white; /* Ensure text is visible */
        }
         body.light-mode .audience-bar {
            color: var(--text); /* Text color for light mode bars */
        }

        .audience-percentage {
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .phone-friend {
            font-style: italic;
            margin: 1rem 0;
            padding: 1rem;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }

        .start-screen, .end-screen {
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .start-button, .restart-button {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.2rem;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 2rem;
            transition: all 0.2s ease;
        }

        .start-button:hover, .restart-button:hover {
            background-color: #d3166d;
            transform: translateY(-2px);
        }

        .category-selector {
            margin: 1rem 0;
        }

        .category {
            background-color: var(--card-bg);
            border: 2px solid var(--secondary);
            color: var(--text);
            padding: 0.8rem 1.5rem;
            margin: 0.5rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .category:hover {
            background-color: var(--secondary);
            color: white;
        }
        body.light-mode .category:hover {
             color: white; /* ensure text stays white on hover for light mode */
        }


        .category.selected {
            background-color: var(--secondary);
            color: white; /* Ensure text is white when selected */
            font-weight: bold;
        }

        .dark-mode-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 10;
            font-size: 1.5rem; /* Make icon larger */
        }
    </style>
</head>
<body>
    <header>
        <h1>Dev Millionaire</h1>
    </header>

    <div class="container">
        <div id="start-screen" class="start-screen">
            <h2>Welcome to Dev Millionaire!</h2>
            <p>Answer up to 15 questions correctly to win the ultimate developer prize!</p>
            
            <div class="category-selector">
                <h3>Select Categories:</h3>
                <div id="categories">
                    <button class="category selected" data-category="all">All Categories</button>
                    <button class="category" data-category="algorithms">Algorithms</button>
                    <button class="category" data-category="databases">Databases</button>
                    <button class="category" data-category="web">Web Development</button>
                    <button class="category" data-category="devops">DevOps</button>
                    <button class="category" data-category="engineering">Software Engineering</button>
                </div>
            </div>
            
            <button id="start-button" class="start-button">Start Game</button>
        </div>

        <div id="game-area" class="game-area" style="display: none;">
            <div class="timer">
                Time left: <span id="timer-value" class="timer-value">30</span>s
            </div>

            <div class="question-container">
                <div id="question" class="question"></div>
                <div id="options" class="options"></div>
            </div>

            <div class="lifelines">
                <button id="fifty-fifty" class="lifeline" title="50:50">50</button>
                <button id="ask-audience" class="lifeline" title="Ask the Audience">A</button>
                <button id="phone-friend" class="lifeline" title="Phone a Friend">P</button>
            </div>

            <div class="progress">
                <!-- Prize levels will be inserted here by JS -->
            </div>
        </div>

        <div id="end-screen" class="end-screen" style="display: none;">
            <h2 id="end-title">Game Over</h2>
            <p id="end-message"></p>
            <p>You won: <span id="prize-won" style="font-weight: bold; color: var(--accent);"></span></p>
            <button id="restart-button" class="restart-button">Play Again</button>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content"> <!-- This is the main modal box -->
            <h2 id="modal-title" class="modal-title"></h2>
            <p id="modal-message" class="modal-message"></p>
            <div id="modal-dynamic-area"></div> <!-- Dedicated area for dynamic content -->
            <button id="modal-button" class="modal-button">Continue</button>
        </div>
    </div>

    <button id="dark-mode-toggle" class="dark-mode-toggle" title="Toggle Light/Dark Mode">üåì</button>

    <script>
        // Game state
        const gameState = {
            currentQuestion: 0,
            score: 0, // Number of correctly answered questions
            timer: 30,
            timerInterval: null,
            lifelines: {
                fiftyFifty: true,
                askAudience: true,
                phoneFriend: true
            },
            selectedCategories: ['all'], // Default to 'all'
            questions: [],
            gameStarted: false,
            isDarkMode: true // Assume starts in dark mode
        };

        // Prize levels
        const prizeLevels = [
            { amount: "$100", safe: false },        // Q1
            { amount: "$200", safe: false },        // Q2
            { amount: "$300", safe: false },        // Q3
            { amount: "$500", safe: false },        // Q4
            { amount: "$1,000", safe: true },       // Q5 - Safe Haven
            { amount: "$2,000", safe: false },       // Q6
            { amount: "$4,000", safe: false },       // Q7
            { amount: "$8,000", safe: false },       // Q8
            { amount: "$16,000", safe: false },      // Q9
            { amount: "$32,000", safe: true },      // Q10 - Safe Haven
            { amount: "$64,000", safe: false },      // Q11
            { amount: "$125,000", safe: false },     // Q12
            { amount: "$250,000", safe: false },     // Q13
            { amount: "$500,000", safe: false },     // Q14
            { amount: "$1,000,000", safe: false }    // Q15 - Grand Prize
        ];

        // Question database (ensure enough variety for 15 questions per category if possible, or rely on 'all')
        const questionDatabase = {
            all: [ // Curated list for "All Categories"
                { question: "What does CSS stand for?", options: ["Computer Style Sheets", "Creative Style Sheets", "Cascading Style Sheets", "Colorful Style Sheets"], answer: 2, category: "web" },
                { question: "Which data structure uses LIFO?", options: ["Queue", "Linked List", "Stack", "Tree"], answer: 2, category: "algorithms" },
                { question: "HTTP default port?", options: ["80", "443", "8080", "21"], answer: 0, category: "web" },
                { question: "Which is NOT a NoSQL database?", options: ["MongoDB", "Cassandra", "PostgreSQL", "Redis"], answer: 2, category: "databases" },
                { question: "ACID in databases stands for?", options: ["Atomicity, Consistency, Isolation, Durability", "Accuracy, Consistency, Integrity, Durability", "Atomicity, Concurrency, Integrity, Durability", "Atomicity, Consistency, Integrity, Distribution"], answer: 0, category: "databases" },
                { question: "Git command to download a repo?", options: ["git pull", "git clone", "git fetch", "git checkout"], answer: 1, category: "devops" },
                { question: "Time complexity of binary search?", options: ["O(1)", "O(n)", "O(log n)", "O(n log n)"], answer: 2, category: "algorithms" },
                { question: "Design pattern for single instance?", options: ["Factory", "Singleton", "Observer", "Decorator"], answer: 1, category: "engineering" },
                { question: "'D' in SOLID principles?", options: ["Data Segregation Principle", "Dependency Inversion Principle", "Direct Inheritance Principle", "Dynamic Binding Principle"], answer: 1, category: "engineering" },
                { question: "Tool for container orchestration?", options: ["Docker", "Kubernetes", "Jenkins", "Ansible"], answer: 1, category: "devops" },
                { question: "Output of '3' + 2 in JavaScript?", options: ["5", "32", "NaN", "Error"], answer: 1, category: "web" },
                { question: "HTTP status code for 'Not Found'?", options: ["200", "301", "404", "500"], answer: 2, category: "web" },
                { question: "Main purpose of a database index?", options: ["Enforce data integrity", "Speed up data retrieval", "Reduce storage space", "Encrypt data"], answer: 1, category: "databases" },
                { question: "Shortest path algorithm in a graph?", options: ["Bubble Sort", "Dijkstra's", "Quick Sort", "Binary Search"], answer: 1, category: "algorithms" },
                { question: "CI/CD in DevOps stands for?", options: ["Continuous Integration/Continuous Deployment", "Code Inspection/Code Deployment", "Computer Infrastructure/Computer Development", "Continuous Improvement/Continuous Development"], answer: 0, category: "devops" }
            ],
            algorithms: [
                { question: "Sorting algorithm with worst O(n¬≤)?", options: ["Merge Sort", "Quick Sort", "Bubble Sort", "Heap Sort"], answer: 2, category: "algorithms" },
                { question: "Space complexity of recursive Fibonacci (no memo)?", options: ["O(1)", "O(n)", "O(n¬≤)", "O(2^n)"], answer: 1, category: "algorithms" }, // Corrected: It's O(n) due to call stack depth
                { question: "What is a greedy algorithm?", options: ["Always finds optimal solution", "Makes locally optimal choices", "Explores all possibilities", "Uses divide and conquer"], answer: 1, category: "algorithms"},
                { question: "Which is NOT a dynamic programming characteristic?", options: ["Overlapping subproblems", "Optimal substructure", "Memoization", "Always uses recursion"], answer: 3, category: "algorithms"},
                { question: "Kruskal's algorithm is used for?", options: ["Shortest Path", "Maximum Flow", "Minimum Spanning Tree", "Network Routing"], answer: 2, category: "algorithms"}
            ],
            databases: [
                { question: "SQL clause to filter groups?", options: ["WHERE", "HAVING", "FILTER", "GROUP BY"], answer: 1, category: "databases" },
                { question: "Purpose of a foreign key?", options: ["Uniquely identify record", "Enforce referential integrity", "Index table", "Encrypt data"], answer: 1, category: "databases" },
                { question: "What is database normalization?", options: ["Speeding up queries", "Reducing data redundancy", "Increasing storage", "Making data read-only"], answer: 1, category: "databases" },
                { question: "Which is a key-value store database?", options: ["MySQL", "PostgreSQL", "MongoDB", "Redis"], answer: 3, category: "databases" },
                { question: "What does 'CAP' theorem relate to?", options: ["Single-node databases", "Distributed databases", "In-memory databases", "Relational databases"], answer: 1, category: "databases"}
            ],
            web: [
                { question: "HTML5 tag for drawing graphics?", options: ["<svg>", "<canvas>", "<graphics>", "<draw>"], answer: 1, category: "web" },
                { question: "'Same Origin Policy' protects against?", options: ["DDoS attacks", "SQL Injection", "Cross-Site Scripting (XSS) by restricting script access", "Server misconfiguration"], answer: 2, category: "web" }, // More specific correct option
                { question: "Which is a JavaScript framework/library?", options: ["Laravel", "Django", "React", "Spring"], answer: 2, category: "web" },
                { question: "HTTP method for creating a new resource?", options: ["GET", "POST", "PUT", "DELETE"], answer: 1, category: "web" },
                { question: "What is WebAssembly (Wasm)?", options: ["A new web browser", "A JavaScript library", "A binary instruction format for the web", "A CSS preprocessor"], answer: 2, category: "web" }
            ],
            devops: [
                { question: "File to define Docker containers?", options: ["Dockerfile", "Containerfile", "Docker.config", "docker-compose.yml"], answer: 0, category: "devops" },
                { question: "Main purpose of Terraform?", options: ["Container orchestration", "Infrastructure as Code", "Continuous Integration", "Monitoring"], answer: 1, category: "devops" },
                { question: "What is 'Infrastructure as Code' (IaC)?", options: ["Writing code for infrastructure apps", "Managing infra via config files/scripts", "Hardware emulation", "A cloud service model"], answer: 1, category: "devops" },
                { question: "Which is a popular CI/CD server?", options: ["Nagios", "Prometheus", "Jenkins", "Puppet"], answer: 2, category: "devops" },
                { question: "What does 'Blue/Green Deployment' mean?", options: ["Deploying to two data centers", "Having two identical environments for release", "Using blue and green colored servers", "A type of load balancer"], answer: 1, category: "devops"}
            ],
            engineering: [
                { question: "Principle: class has one reason to change?", options: ["Open/Closed", "Liskov Substitution", "Interface Segregation", "Single Responsibility"], answer: 3, category: "engineering" },
                { question: "Main goal of Observer pattern?", options: ["Create objects without specifying class", "Define one-to-many dependency", "Add responsibilities dynamically", "Unified interface to interfaces"], answer: 1, category: "engineering" },
                { question: "What is 'Agile' methodology?", options: ["A specific programming language", "A project management framework", "A software testing tool", "A database design principle"], answer: 1, category: "engineering" },
                { question: "Which 'SOLID' principle promotes coding to interfaces, not implementations?", options: ["Single Responsibility", "Open/Closed", "Liskov Substitution", "Dependency Inversion"], answer: 3, category: "engineering" },
                { question: "What is 'Refactoring'?", options: ["Adding new features", "Fixing bugs", "Improving internal code structure without changing external behavior", "Rewriting code from scratch"], answer: 2, category: "engineering"}
            ]
        };

        // DOM elements
        const elements = {
            startScreen: document.getElementById('start-screen'),
            gameArea: document.getElementById('game-area'),
            endScreen: document.getElementById('end-screen'),
            question: document.getElementById('question'),
            options: document.getElementById('options'),
            timerValue: document.getElementById('timer-value'),
            startButton: document.getElementById('start-button'),
            restartButton: document.getElementById('restart-button'),
            fiftyFifty: document.getElementById('fifty-fifty'),
            askAudience: document.getElementById('ask-audience'),
            phoneFriend: document.getElementById('phone-friend'),
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            modalDynamicArea: document.getElementById('modal-dynamic-area'), // Corrected
            modalButton: document.getElementById('modal-button'),
            endTitle: document.getElementById('end-title'),
            endMessage: document.getElementById('end-message'),
            prizeWon: document.getElementById('prize-won'),
            categories: document.getElementById('categories'),
            darkModeToggle: document.getElementById('dark-mode-toggle'),
            progressContainer: document.querySelector('.progress') // Added for prize levels
        };

        // Utility function to shuffle array (Fisher-Yates shuffle)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Initialize the game
        function initGame() {
            elements.startButton.addEventListener('click', startGame);
            elements.restartButton.addEventListener('click', restartGame);
            elements.fiftyFifty.addEventListener('click', useFiftyFifty);
            elements.askAudience.addEventListener('click', useAskAudience);
            elements.phoneFriend.addEventListener('click', usePhoneFriend);
            elements.modalButton.addEventListener('click', closeModal);
            elements.darkModeToggle.addEventListener('click', toggleDarkMode);

            const categoryButtons = elements.categories.querySelectorAll('.category');
            categoryButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const category = button.dataset.category;
                    const allCategoryButton = elements.categories.querySelector('.category[data-category="all"]');

                    if (category === 'all') {
                        gameState.selectedCategories = ['all'];
                        categoryButtons.forEach(btn => btn.classList.remove('selected'));
                        allCategoryButton.classList.add('selected');
                    } else {
                        if (gameState.selectedCategories.includes('all')) {
                            gameState.selectedCategories = [];
                            allCategoryButton.classList.remove('selected');
                        }
                        
                        const index = gameState.selectedCategories.indexOf(category);
                        if (index === -1) {
                            gameState.selectedCategories.push(category);
                            button.classList.add('selected');
                        } else {
                            gameState.selectedCategories.splice(index, 1);
                            button.classList.remove('selected');
                        }
                        
                        if (gameState.selectedCategories.length === 0) {
                            gameState.selectedCategories = ['all'];
                            allCategoryButton.classList.add('selected');
                        }
                    }
                });
            });

            elements.progressContainer.innerHTML = ''; // Clear previous prize levels if any
            prizeLevels.forEach((level, index) => {
                const levelElement = document.createElement('div');
                levelElement.className = 'prize-level';
                levelElement.innerHTML = `
                    <span>Question ${index + 1}</span>
                    <span class="prize-amount">${level.amount}</span>
                    ${level.safe ? '<span>(Safe Haven)</span>' : ''}
                `;
                elements.progressContainer.appendChild(levelElement);
            });

            elements.startScreen.style.display = 'block';
            elements.gameArea.style.display = 'none';
            elements.endScreen.style.display = 'none';
            
            // Set initial dark mode state from system preference or localStorage if implemented
            // For now, keep it simple as per gameState.isDarkMode
            if (!gameState.isDarkMode) { // If default is light
                 document.body.classList.add('light-mode');
                 elements.darkModeToggle.textContent = 'üåô';
            } else {
                 document.body.classList.remove('light-mode');
                 elements.darkModeToggle.textContent = '‚òÄÔ∏è';
            }

        }

        function startGame() {
            gameState.currentQuestion = 0;
            gameState.score = 0;
            gameState.lifelines = { fiftyFifty: true, askAudience: true, phoneFriend: true };
            gameState.gameStarted = true;

            gameState.questions = [];
            if (gameState.selectedCategories.includes('all')) {
                gameState.questions = [...questionDatabase.all]; // Use a copy of the curated 'all' list
            } else {
                gameState.selectedCategories.forEach(categoryKey => {
                    if (questionDatabase[categoryKey]) {
                        gameState.questions = gameState.questions.concat(questionDatabase[categoryKey]);
                    }
                });
            }

            gameState.questions = shuffleArray(gameState.questions); // Shuffle the chosen pool
            if (gameState.questions.length > 15) { // Cap at 15 questions
                gameState.questions = gameState.questions.slice(0, 15);
            }
            
            if (gameState.questions.length === 0) {
                alert("No questions available for the selected categories. Please try different selections.");
                elements.startScreen.style.display = 'block';
                elements.gameArea.style.display = 'none';
                gameState.gameStarted = false;
                return;
            }
            // Dynamically adjust prize ladder if fewer than 15 questions
            // For simplicity, we'll keep the 15-level prize ladder display,
            // but the game will end when questions run out.

            elements.startScreen.style.display = 'none';
            elements.gameArea.style.display = 'flex';
            elements.endScreen.style.display = 'none';

            elements.fiftyFifty.disabled = false;
            elements.askAudience.disabled = false;
            elements.phoneFriend.disabled = false;

            loadQuestion();
        }

        function loadQuestion() {
            if (gameState.currentQuestion >= gameState.questions.length) {
                endGame(true); // All available questions answered correctly
                return;
            }

            resetTimer();
            updateProgress();

            const questionData = gameState.questions[gameState.currentQuestion];
            elements.question.textContent = questionData.question;
            elements.options.innerHTML = '';

            const optionPrefixes = ['A', 'B', 'C', 'D'];
            questionData.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option';
                button.innerHTML = `
                    <span class="option-prefix">${optionPrefixes[index]}</span>
                    <span>${option}</span>
                `;
                button.dataset.index = index;
                button.addEventListener('click', () => selectAnswer(index));
                elements.options.appendChild(button);
            });
        }

        function selectAnswer(selectedIndex) {
            clearInterval(gameState.timerInterval);
            const optionButtons = Array.from(elements.options.querySelectorAll('.option'));
            optionButtons.forEach(button => button.disabled = true);

            const questionData = gameState.questions[gameState.currentQuestion];
            const correctIndex = questionData.answer;

            optionButtons[correctIndex].classList.add('correct');
            if (selectedIndex === correctIndex) {
                gameState.score++;
                playSound('correct');
                setTimeout(() => {
                    gameState.currentQuestion++;
                    if (gameState.currentQuestion >= gameState.questions.length) {
                        endGame(true); // Won all available questions
                    } else {
                        loadQuestion();
                    }
                }, 2000);
            } else {
                optionButtons[selectedIndex].classList.add('wrong');
                playSound('wrong');
                setTimeout(() => endGame(false), 2000);
            }
        }

        function useFiftyFifty() {
            if (!gameState.lifelines.fiftyFifty) return;
            gameState.lifelines.fiftyFifty = false;
            elements.fiftyFifty.disabled = true;

            const questionData = gameState.questions[gameState.currentQuestion];
            const correctIndex = questionData.answer;
            const incorrectOptions = [];
            for (let i = 0; i < questionData.options.length; i++) {
                if (i !== correctIndex) incorrectOptions.push(i);
            }
            
            shuffleArray(incorrectOptions);
            const toRemove = incorrectOptions.slice(0, 2);
            
            const optionButtons = elements.options.querySelectorAll('.option');
            toRemove.forEach(index => {
                optionButtons[index].disabled = true;
                optionButtons[index].style.opacity = '0.3';
                optionButtons[index].innerHTML = `
                    <span class="option-prefix">${optionButtons[index].querySelector('.option-prefix').textContent}</span>
                    <span>¬†</span>`; // Clear text but keep prefix
            });
            playSound('lifeline');
        }

        function useAskAudience() {
            if (!gameState.lifelines.askAudience) return;
            gameState.lifelines.askAudience = false;
            elements.askAudience.disabled = true;

            const questionData = gameState.questions[gameState.currentQuestion];
            const correctIndex = questionData.answer;
            const percentages = [0, 0, 0, 0];
            let remaining = 100;
            
            const correctPercent = Math.floor(Math.random() * 31) + 50; // 50-80% for correct
            percentages[correctIndex] = correctPercent;
            remaining -= correctPercent;
            
            const otherIndices = [0,1,2,3].filter(i => i !== correctIndex);
            shuffleArray(otherIndices);

            for (let i = 0; i < otherIndices.length; i++) {
                const idx = otherIndices[i];
                if (i === otherIndices.length - 1) {
                    percentages[idx] = remaining;
                } else {
                    const percent = Math.floor(Math.random() * (remaining + 1));
                    percentages[idx] = percent;
                    remaining -= percent;
                }
            }
            
            showModal(
                "Ask the Audience",
                "The audience poll results:",
                `
                <div class="audience-chart">
                    ${percentages.map((p, i) => `
                    <div class="audience-bar" style="height: ${p}%">
                        <span class="audience-percentage">${p}%</span>
                        <span>${['A', 'B', 'C', 'D'][i]}</span>
                    </div>`).join('')}
                </div>
                `
            );
            playSound('lifeline');
        }

        function usePhoneFriend() {
            if (!gameState.lifelines.phoneFriend) return;
            gameState.lifelines.phoneFriend = false;
            elements.phoneFriend.disabled = true;

            const questionData = gameState.questions[gameState.currentQuestion];
            const correctIndex = questionData.answer;
            const friendNames = ["Alice", "Bob", "Charlie", "DevDave", "Eve", "CodeFrank", "GraceHopper.js"];
            const friendName = friendNames[Math.floor(Math.random() * friendNames.length)];
            
            let friendAnswerIndex;
            if (Math.random() < 0.75) { // 75% chance friend is right
                friendAnswerIndex = correctIndex;
            } else {
                const otherOptions = [0,1,2,3].filter(i => i !== correctIndex);
                friendAnswerIndex = otherOptions[Math.floor(Math.random() * otherOptions.length)];
            }
            
            const optionLetters = ['A', 'B', 'C', 'D'];
            const confidence = ["I'm pretty sure it's", "I think it might be", "Hmm, tough one... maybe", "My gut says"];
            
            showModal(
                "Phone a Friend",
                `You called ${friendName}...`,
                `
                <div class="phone-friend">
                    "${confidence[Math.floor(Math.random()*confidence.length)]} <strong>${optionLetters[friendAnswerIndex]}</strong>. Good luck!"
                </div>
                `
            );
            playSound('lifeline');
        }

        function showModal(title, message, dynamicContentHTML = '') {
            clearInterval(gameState.timerInterval); // Pause timer
            elements.modalTitle.textContent = title;
            elements.modalMessage.textContent = message;
            elements.modalDynamicArea.innerHTML = dynamicContentHTML;
            elements.modal.classList.add('show');
        }

        function closeModal() {
            elements.modal.classList.remove('show');
            elements.modalDynamicArea.innerHTML = ''; // Clear dynamic content
            if (gameState.gameStarted && elements.gameArea.style.display === 'flex' && gameState.currentQuestion < gameState.questions.length) {
                 // Resume timer only if game is active and not ended
                resetTimer();
            }
        }

        function endGame(isWinner) {
            clearInterval(gameState.timerInterval);
            gameState.gameStarted = false;
            let prizeMoney = "$0";

            if (isWinner && gameState.score === gameState.questions.length) { // Won all questions in the current set
                elements.endTitle.textContent = "Congratulations!";
                elements.endMessage.textContent = `You've answered all ${gameState.questions.length} questions correctly!`;
                // Award the prize for the last question successfully answered
                prizeMoney = prizeLevels[Math.min(gameState.score - 1, prizeLevels.length - 1)].amount;

            } else { // Lost or ran out of time
                elements.endTitle.textContent = "Game Over";
                elements.endMessage.textContent = `You answered ${gameState.score} out of ${gameState.questions.length} questions correctly.`;
                
                // Calculate prize based on last safe haven reached
                // gameState.score is the number of questions answered correctly
                if (gameState.score > 0) {
                    for (let i = 0; i < gameState.score; i++) {
                        // Check prizeLevels up to the one before the failed question
                        // prizeLevels are 0-indexed, gameState.score is 1-indexed count
                        if (prizeLevels[i] && prizeLevels[i].safe) {
                            prizeMoney = prizeLevels[i].amount;
                        }
                    }
                }
                // If no safe haven reached and score > 0, and first levels are not $0
                // This rule may vary. Default is $0 if no safe haven.
                // However, if the first level itself ($100) is considered won upon reaching it:
                if (prizeMoney === "$0" && gameState.score > 0 && !prizeLevels[0].safe) {
                     // If they got at least one question right, and the base prize isn't $0, they get the prize for the last correctly answered question IF no safe haven was hit
                     // This is complex. Sticking to standard: only safe havens count on loss.
                     // The current prizeLevel structure: $100 (not safe), $1000 (safe).
                     // So if they get 1-4 questions right, they get $0.
                     // If they get 5 questions right ($1000 level), they secure $1000.
                }
            }
            
            elements.prizeWon.textContent = prizeMoney;
            
            elements.startScreen.style.display = 'none';
            elements.gameArea.style.display = 'none';
            elements.endScreen.style.display = 'block';

            playSound(isWinner && gameState.score === prizeLevels.length ? 'grand_win' : (isWinner ? 'win_round' : 'lose'));
        }

        function restartGame() {
            elements.startScreen.style.display = 'block';
            elements.gameArea.style.display = 'none';
            elements.endScreen.style.display = 'none';
            // gameState reset is handled in startGame
        }

        function updateProgress() {
            const prizeElements = elements.progressContainer.querySelectorAll('.prize-level');
            prizeElements.forEach((element, index) => {
                element.classList.remove('current', 'passed');
                if (index === gameState.currentQuestion) {
                    element.classList.add('current');
                } else if (index < gameState.currentQuestion) {
                    element.classList.add('passed');
                }
            });
        }

        function resetTimer() {
            clearInterval(gameState.timerInterval);
            gameState.timer = 30; // Or make this configurable per question level
            elements.timerValue.textContent = gameState.timer;
            
            if (elements.gameArea.style.display !== 'flex' || !gameState.gameStarted) return; // Don't start if not in game

            gameState.timerInterval = setInterval(() => {
                gameState.timer--;
                elements.timerValue.textContent = gameState.timer;
                if (gameState.timer <= 0) {
                    clearInterval(gameState.timerInterval);
                    playSound('timeout');
                    endGame(false); // False for 'isWinner'
                }
            }, 1000);
        }

        function playSound(type) {
            // Placeholder for sound effects
            // console.log(`Playing sound: ${type}`);
            // Example using Audio API if you have sound files:
            // const audio = new Audio(`sounds/${type}.mp3`);
            // audio.play().catch(e => console.warn("Audio play failed:", e));
        }

        function toggleDarkMode() {
            gameState.isDarkMode = !gameState.isDarkMode;
            document.body.classList.toggle('light-mode', !gameState.isDarkMode);
            elements.darkModeToggle.textContent = gameState.isDarkMode ? '‚òÄÔ∏è' : 'üåô';
            elements.darkModeToggle.title = gameState.isDarkMode ? "Switch to Light Mode" : "Switch to Dark Mode";
        }

        // Initialize the game when the script loads
        initGame();
    </script>
</body>
</html>